<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片压缩工具</title>
    <link rel="icon" type="image/ico" href="image-fill.ico">
    <style>
        @font-face {
            font-family: 'SmileySans-Oblique-2';
            src: url('SmileySans-Oblique-2.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'SmileySans-Oblique-2', sans-serif;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        :root {
            --bg-color: #f5f7fa;
            --text-color: #333333;
            --container-bg: white;
            --border-color: #e1e5eb;
            --section-border: #555555;
            --primary-color: #333333;
            --primary-hover: #555555;
            --secondary-bg: #f0f0f0;
            --secondary-hover: #e0e0e0;
            --secondary-text: #333333;
            --success-color: #27ae60;
            --success-hover: #219653;
            --error-color: #e74c3c;
            --error-bg: #fdecea;
            --warning-bg: #fff9e6;
            --warning-border: #f1c40f;
            --warning-text: #e67e22;
            --placeholder-bg: #f8f9fa;
            --placeholder-border: #bdc3c7;
            --placeholder-text: #7f8c8d;
            --stats-bg: #f8f9fa;
            --stats-border: #e9ecef;
            --stats-label: #6c757d;
            --slider-bg: #dfe6e9;
            --remove-btn-bg: #f5f7fa;
            --remove-btn-border: #e0e0e0;
            --remove-btn-color: #95a5a6;
            --remove-btn-hover: #edf2f7;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --theme-btn-bg: #f0f0f0;
            --theme-btn-hover: #e0e0e0;
            --theme-icon-color: #666666;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --modal-bg: rgba(255, 255, 255, 0.15);
            --modal-border: rgba(255, 255, 255, 0.2);
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
        }

        .dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --container-bg: #2d2d2d;
            --border-color: #404040;
            --section-border: #888888;
            --primary-color: #f0f0f0;
            --primary-hover: #ffffff;
            --secondary-bg: #404040;
            --secondary-hover: #505050;
            --secondary-text: #f0f0f0;
            --success-color: #27ae60;
            --success-hover: #219653;
            --error-color: #e74c3c;
            --error-bg: #3c1f1f;
            --warning-bg: #3c2e1f;
            --warning-border: #f39c12;
            --warning-text: #f1c40f;
            --placeholder-bg: #333333;
            --placeholder-border: #555555;
            --placeholder-text: #aaaaaa;
            --stats-bg: #333333;
            --stats-border: #404040;
            --stats-label: #aaaaaa;
            --slider-bg: #555555;
            --remove-btn-bg: #404040;
            --remove-btn-border: #555555;
            --remove-btn-color: #aaaaaa;
            --remove-btn-hover: #505050;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --theme-btn-bg: #404040;
            --theme-btn-hover: #505050;
            --theme-icon-color: #ffffff;
            --glass-bg: rgb(46, 46, 46);
            --glass-border: rgba(183, 183, 183, 0.2);
            --modal-bg: rgb(0, 0, 0);
            --modal-border: rgba(0, 0, 0, 0.3);
            --card-bg: rgba(56, 56, 56, 0.5);
            --card-border: rgba(183, 183, 183, 0.1);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            color: var(--placeholder-text);
            font-size: 1.1rem;
        }
        
        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .theme-label {
            font-size: 0.9rem;
            color: var(--text-color);
        }
        
        .theme-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--theme-btn-bg);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .theme-btn:hover {
            background-color: var(--theme-btn-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        .theme-btn:active {
            transform: translateY(0);
        }
        
        .sun-icon, .moon-icon {
            position: absolute;
            width: 24px;
            height: 24px;
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .sun-icon {
            opacity: 1;
            transform: scale(1);
        }
        
        .dark-mode .sun-icon {
            opacity: 0;
            transform: scale(0.5) rotate(90deg);
        }
        
        .moon-icon {
            opacity: 0;
            transform: scale(0.5) rotate(-90deg);
        }
        
        .dark-mode .moon-icon {
            opacity: 1;
            transform: scale(1) rotate(0);
        }
        
        .sun-circle {
            fill: var(--theme-icon-color);
        }
        
        .sun-rays {
            fill: var(--theme-icon-color);
        }
        
        .moon-body {
            fill: var(--theme-icon-color);
        }
        
        .moon-crater {
            fill: var(--theme-icon-color);
            opacity: 0.7;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .upload-section, .preview-section {
            flex: 1;
            min-width: 300px;
            background: var(--container-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .section-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--section-border);
        }
        
        .upload-area {
            border: 3px dashed var(--placeholder-border);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 25px;
            transition: all 0.3s;
            cursor: pointer;
            background-color: var(--placeholder-bg);
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: var(--placeholder-bg);
        }
        
        .upload-list {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .upload-subtext {
            color: var(--placeholder-text);
            font-size: 0.9rem;
        }
        
        .file-input {
            display: none;
        }
        
        .file-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            gap: 10px;
        }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-size {
            font-size: 0.85rem;
            color: var(--placeholder-text);
        }
        
        .remove-file {
            color: var(--remove-btn-color);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            background-color: var(--remove-btn-bg);
            border: 1px solid var(--remove-btn-border);
            font-size: 0.85rem;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .remove-file:hover {
            background-color: var(--remove-btn-hover);
            color: var(--error-color);
        }
        
        .controls {
            margin-top: 25px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-label {
            display: block;
            margin-bottom: 8px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            background: var(--slider-bg);
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 3px solid var(--container-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .slider-value {
            color: var(--primary-color);
            min-width: 40px;
        }
        
        .quality-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--placeholder-text);
            margin-top: 5px;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .dark-mode .btn-primary {
            color: #333333;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--secondary-bg);
            color: var(--secondary-text);
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-hover);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .preview-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .image-comparison {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .image-box {
            flex: 1;
            text-align: center;
        }
        
        .image-title {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .image-placeholder {
            height: 200px;
            background-color: var(--placeholder-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--placeholder-text);
            border: 1px dashed var(--placeholder-border);
            overflow: hidden;
            position: relative;
        }
        
        .image-placeholder img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }
        
        .image-placeholder .placeholder-text {
            position: absolute;
        }
        
        .image-placeholder.has-image .placeholder-text {
            display: none;
        }
        
        .image-placeholder.has-image img {
            display: block;
        }
        
        .stats {
            background-color: var(--stats-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 10px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--stats-border);
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: var(--stats-label);
        }
        
        .savings {
            color: var(--success-color);
        }
        
        .negative {
            color: var(--error-color);
        }
        
        .warning-message {
            background-color: var(--warning-bg);
            color: var(--warning-text);
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9rem;
            display: none;
            border-left: 4px solid var(--warning-border);
        }
        
        .download-section {
            text-align: center;
            margin-top: 20px;
        }
        
        .btn-download {
            background-color: var(--success-color);
            color: white;
            padding: 14px 30px;
            font-size: 1.1rem;
        }
        
        .btn-download:hover {
            background-color: var(--success-hover);
        }
        
        .hidden {
            display: none;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            color: var(--placeholder-text);
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        footer a {
            color: var(--placeholder-text);
            text-decoration: none;
            transition: color 0.3s;
            margin: 0 5px;
        }

        footer a:hover {
            color: var(--primary-color);
        }
        
        .error-message {
            background-color: var(--error-bg);
            color: var(--error-color);
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .image-comparison {
                flex-direction: column;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .file-item {
                flex-wrap: wrap;
            }
            
            .remove-file {
                margin-left: auto;
            }
            
            .theme-toggle {
                position: relative;
                justify-content: center;
                margin-top: 20px;
                top: auto;
                right: auto;
            }
        }

        .support-page {
            display: none;
            width: 100%;
            background: var(--glass-bg);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .support-page h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--primary-color);
        }
        
        .support-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }
        
        @media (min-width: 769px) {
            .support-container {
                flex-direction: row;
                justify-content: center;
                align-items: flex-start;
                gap: 3rem;
            }
            
            .support-item {
                flex: 0 1 auto;
                max-width: 300px;
            }
            
            .support-image-container {
                width: 220px;
                height: 220px;
            }
        }
        
        @media (max-width: 768px) {
            .support-container {
                flex-direction: column;
                gap: 2rem;
            }
            
            .support-item {
                width: 100%;
            }
            
            .support-image-container {
                width: 200px;
                height: 200px;
            }
        }
        
        .support-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .support-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .support-image-container {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .support-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }
        
        .support-description {
            font-size: 1rem;
            text-align: center;
            opacity: 0.9;
            line-height: 1.4;
            margin-top: 1rem;
            color: var(--text-color);
        }
        
        .support-message {
            font-size: 1.1rem;
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            color: var(--text-color);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .support-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            align-items: center;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>图片压缩工具</h1>
            <p class="subtitle">在线压缩JPG、PNG、WebP格式图片文件大小，保护隐私，无需上传服务器即可压缩。</p>
            
            <div class="theme-toggle">
                <span class="theme-label">主题</span>
                <button class="theme-btn" id="themeBtn" aria-label="切换主题">
                    <svg class="sun-icon" viewBox="0 0 24 24" width="24" height="24">
                        <circle class="sun-circle" cx="12" cy="12" r="5"/>
                        <line class="sun-rays" x1="12" y1="1" x2="12" y2="4"/>
                        <line class="sun-rays" x1="12" y1="20" x2="12" y2="23"/>
                        <line class="sun-rays" x1="4.22" y1="4.22" x2="6.34" y2="6.34"/>
                        <line class="sun-rays" x1="17.66" y1="17.66" x2="19.78" y2="19.78"/>
                        <line class="sun-rays" x1="1" y1="12" x2="4" y2="12"/>
                        <line class="sun-rays" x1="20" y1="12" x2="23" y2="12"/>
                        <line class="sun-rays" x1="4.22" y1="19.78" x2="6.34" y2="17.66"/>
                        <line class="sun-rays" x1="17.66" y1="6.34" x2="19.78" y2="4.22"/>
                    </svg>
                    
                    <svg class="moon-icon" viewBox="0 0 24 24" width="24" height="24">
                        <path class="moon-body" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        <circle class="moon-crater" cx="15" cy="10" r="1.5"/>
                        <circle class="moon-crater" cx="12" cy="15" r="1"/>
                        <circle class="moon-crater" cx="17" cy="15" r="0.8"/>
                    </svg>
                </button>
            </div>
        </header>
        
        <div class="main-content" id="mainContent">
            <section class="upload-section">
                <h2 class="section-title">上传图片</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-list">点击上传图片</div>
                    <p class="upload-text">拖放图片文件到此处或点击选择</p>
                    <p class="upload-subtext">支持JPG、PNG、WebP格式，单张图片限制50MB以内，每次仅处理一张图片</p>
                    <input type="file" id="fileInput" class="file-input" accept="image/*">
                </div>
                
                <div class="file-list" id="fileList"></div>
                
                <div class="controls">
                    <div class="control-group">
                        <label class="control-label">压缩质量：<span id="qualityValue">80</span>%</label>
                        <div class="slider-container">
                            <input type="range" min="10" max="100" value="80" class="slider" id="qualitySlider">
                            <span class="slider-value" id="qualityDisplay">80%</span>
                        </div>
                        <div class="quality-label">
                            <span>小</span>
                            <span>大</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">输出格式</label>
                        <div class="slider-container">
                            <select id="formatSelect" class="slider" style="height: 40px; padding: 0 10px; border-radius: 6px; border: 1px solid var(--placeholder-border); background-color: var(--container-bg); color: var(--text-color);">
                                <option value="original">原始格式</option>
                                <option value="jpeg">JPEG（与JPG相同，有损压缩格式）</option>
                                <option value="png">PNG（上传图像若包含透明背景，保持透明请选择它）</option>
                                <option value="webp">WebP（Web类使用，占用容量最小）</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="buttons">
                    <button id="compressBtn" class="btn btn-primary">压缩图片</button>
                    <button id="clearBtn" class="btn btn-secondary">清除所有</button>
                </div>
                
                <div id="errorMessage" class="error-message"></div>
            </section>
            
            <section class="preview-section">
                <h2 class="section-title">压缩结果</h2>
                
                <div class="preview-container">
                    <div class="image-comparison">
                        <div class="image-box">
                            <div class="image-title">原始图片</div>
                            <div id="originalPreview" class="image-placeholder">
                                <span class="placeholder-text">待上传</span>
                                <img id="originalImage" alt="原始图片">
                            </div>
                        </div>
                        <div class="image-box">
                            <div class="image-title">压缩图片</div>
                            <div id="compressedPreview" class="image-placeholder">
                                <span class="placeholder-text">待压缩</span>
                                <img id="compressedImage" alt="压缩图片">
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats" id="statsContainer">
                        <div class="stat-row">
                            <span class="stat-label">原始大小</span>
                            <span class="stat-value" id="originalSize">0 KB</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">压缩大小</span>
                            <span class="stat-value" id="compressedSize">0 KB</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">节省空间</span>
                            <span class="stat-value" id="savings">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">压缩比例</span>
                            <span class="stat-value" id="compressionRatio">0%</span>
                        </div>
                    </div>
                    
                    <div id="warningMessage" class="warning-message"></div>
                    
                    <div class="download-section hidden" id="downloadSection">
                        <button id="downloadBtn" class="btn btn-download">下载压缩图片</button>
                    </div>
                </div>
            </section>
        </div>

        <div class="support-page" id="supportPage">
            <h2>支持页面</h2>
            <div class="support-container">
                <div class="support-item">
                    <div class="support-title">微信支付</div>
                    <div class="support-image-container">
                        <img src="QR/Wechat_QRC.webp" alt="微信支付" class="support-image" id="wechatQrCode">
                    </div>
                </div>
                
                <div class="support-item">
                    <div class="support-title">支付宝</div>
                    <div class="support-image-container">
                        <img src="QR/Alipay_QR.webp" alt="支付宝" class="support-image" id="alipayQrCode">
                    </div>
                </div>
            </div>
            <div class="support-message">
                如果对你有帮助，请支持我。谢谢！
            </div>
            <div class="support-buttons">
                <button class="btn btn-primary" id="backFromSupport">返回</button>
            </div>
        </div>
        
        <footer>
            <p><a href="#" id="supportLink">支持</a> | <a href="https://m-pureruby.github.io/PureRuby" target="_blank">个人博客：Pure Ruby</a></p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const fileList = document.getElementById('fileList');
            const qualitySlider = document.getElementById('qualitySlider');
            const qualityValue = document.getElementById('qualityValue');
            const qualityDisplay = document.getElementById('qualityDisplay');
            const compressBtn = document.getElementById('compressBtn');
            const clearBtn = document.getElementById('clearBtn');
            const originalPreview = document.getElementById('originalPreview');
            const originalImage = document.getElementById('originalImage');
            const compressedPreview = document.getElementById('compressedPreview');
            const compressedImage = document.getElementById('compressedImage');
            const originalSize = document.getElementById('originalSize');
            const compressedSize = document.getElementById('compressedSize');
            const savings = document.getElementById('savings');
            const compressionRatio = document.getElementById('compressionRatio');
            const downloadSection = document.getElementById('downloadSection');
            const downloadBtn = document.getElementById('downloadBtn');
            const errorMessage = document.getElementById('errorMessage');
            const formatSelect = document.getElementById('formatSelect');
            const statsContainer = document.getElementById('statsContainer');
            const warningMessage = document.getElementById('warningMessage');
            const themeBtn = document.getElementById('themeBtn');

            const supportLink = document.getElementById('supportLink');
            const supportPage = document.getElementById('supportPage');
            const backFromSupportBtn = document.getElementById('backFromSupport');
            const mainContent = document.getElementById('mainContent');

            let files = [];
            let compressedBlob = null;
            let compressedFileName = '';

            function initTheme() {
                const savedTheme = localStorage.getItem('theme');
                const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
                
                if (savedTheme) {
                    if (savedTheme === 'dark') {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                } else {
                    if (prefersDarkScheme.matches) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                }
            }
            
            function toggleTheme() {
                if (document.body.classList.contains('dark-mode')) {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                } else {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                }
            }
            
            themeBtn.addEventListener('click', toggleTheme);
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                }
            });

            initTheme();

            supportLink.addEventListener('click', function(e) {
                e.preventDefault();
                showSupportPage();
            });
            
            backFromSupportBtn.addEventListener('click', function() {
                hideSupportPage();
            });
            
            function showSupportPage() {
                mainContent.style.display = 'none';
                supportPage.style.display = 'block';
            }
            
            function hideSupportPage() {
                mainContent.style.display = 'flex';
                supportPage.style.display = 'none';
            }

            function updateQualityDisplay() {
                const value = qualitySlider.value;
                qualityValue.textContent = value;
                qualityDisplay.textContent = value + '%';
            }
            
            updateQualityDisplay();
            qualitySlider.addEventListener('input', updateQualityDisplay);

            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 1) {
                    showError('每次只能处理一张图片，请只拖动一个文件');
                    return;
                }
                
                handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 1) {
                    showError('每次只能处理一张图片，请只选择一个文件');
                    e.target.value = '';
                    return;
                }
                
                handleFiles(e.target.files);
                e.target.value = '';
            });
            
            function handleFiles(selectedFiles) {
                errorMessage.style.display = 'none';
                
                if (selectedFiles.length === 0) return;
                
                const file = selectedFiles[0];
                
                if (!file.type.startsWith('image/')) {
                    showError('请选择有效的图片文件（JPG、PNG、WebP等格式）');
                    return;
                }
                
                if (file.size > 50 * 1024 * 1024) {
                    showError(`文件 "${file.name}" 超过50MB限制`);
                    return;
                }
                
                files = [file];
                updateFileList();
                previewOriginalImage(file);
            }

            function updateFileList() {
                fileList.innerHTML = '';
                
                if (files.length === 0) return;
                
                const file = files[0];
                const fileSize = formatFileSize(file.size);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name" title="${file.name}">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                    </div>
                    <div class="remove-file" id="removeFileBtn">删除</div>
                `;
                
                fileList.appendChild(fileItem);

                document.getElementById('removeFileBtn').addEventListener('click', function() {
                    files = [];
                    updateFileList();
                    resetPreview();
                });
            }

            function previewOriginalImage(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    originalImage.src = e.target.result;
                    originalPreview.classList.add('has-image');
                    
                    originalSize.textContent = formatFileSize(file.size);
                    statsContainer.style.display = 'block';
                    warningMessage.style.display = 'none';

                    compressedPreview.classList.remove('has-image');
                    compressedImage.src = '';
                    compressedSize.textContent = '0 KB';
                    savings.textContent = '0%';
                    savings.className = 'stat-value';
                    compressionRatio.textContent = '0%';
                    downloadSection.classList.add('hidden');
                };
                
                reader.readAsDataURL(file);
            }

            async function compressImage(file, quality, format) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = new Image();
                        
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            canvas.width = img.width;
                            canvas.height = img.height;

                            ctx.drawImage(img, 0, 0);

                            let mimeType;
                            switch(format) {
                                case 'jpeg':
                                    mimeType = 'image/jpeg';
                                    break;
                                case 'png':
                                    mimeType = 'image/png';
                                    break;
                                case 'webp':
                                    mimeType = 'image/webp';
                                    break;
                                default:
                                    mimeType = file.type;
                            }

                            canvas.toBlob(
                                blob => {
                                    if (blob) {
                                        resolve({
                                            blob,
                                            originalSize: file.size,
                                            compressedSize: blob.size
                                        });
                                    } else {
                                        reject(new Error('图片压缩失败'));
                                    }
                                },
                                mimeType,
                                quality / 100
                            );
                        };
                        
                        img.onerror = function() {
                            reject(new Error('图片加载失败'));
                        };
                        
                        img.src = e.target.result;
                    };
                    
                    reader.onerror = function() {
                        reject(new Error('文件读取失败'));
                    };
                    
                    reader.readAsDataURL(file);
                });
            }

            compressBtn.addEventListener('click', async () => {
                if (files.length === 0) {
                    showError('请先选择图片文件');
                    return;
                }

                compressBtn.disabled = true;
                compressBtn.textContent = '压缩中...';
                errorMessage.style.display = 'none';
                warningMessage.style.display = 'none';
                
                try {
                    const file = files[0];
                    const quality = parseInt(qualitySlider.value);
                    const format = formatSelect.value === 'original' ? 
                        file.type.split('/')[1] : formatSelect.value;

                    const result = await compressImage(file, quality, format);

                    const blobUrl = URL.createObjectURL(result.blob);
                    compressedImage.src = blobUrl;
                    compressedPreview.classList.add('has-image');

                    compressedSize.textContent = formatFileSize(result.compressedSize);
                    
                    const savingPercent = ((result.originalSize - result.compressedSize) / result.originalSize * 100).toFixed(1);
                    const isNegative = parseFloat(savingPercent) < 0;
                    
                    if (isNegative) {
                        savings.className = 'stat-value negative';
                        savings.textContent = savingPercent + '%';

                        warningMessage.textContent = '压缩失败！可能文件本身容量已经很小了！或文件出错，请更换格式再压缩。';
                        warningMessage.style.display = 'block';
                    } else {
                        savings.className = 'stat-value savings';
                        savings.textContent = savingPercent + '%';
                        warningMessage.style.display = 'none';
                    }
                    
                    const compressionPercent = (result.compressedSize / result.originalSize * 100).toFixed(1);
                    compressionRatio.textContent = compressionPercent + '%';

                    compressedBlob = result.blob;
                    compressedFileName = file.name.replace(/\.[^/.]+$/, "") + '_compressed.' + format;

                    downloadSection.classList.remove('hidden');
                    
                } catch (error) {
                    showError('压缩过程中发生错误：' + error.message);
                } finally {
                    compressBtn.disabled = false;
                    compressBtn.textContent = '压缩图片';
                }
            });

            clearBtn.addEventListener('click', () => {
                files = [];
                compressedBlob = null;
                updateFileList();
                resetPreview();
                errorMessage.style.display = 'none';
                warningMessage.style.display = 'none';
                fileInput.value = '';
            });

            downloadBtn.addEventListener('click', () => {
                if (compressedBlob) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(compressedBlob);
                    link.download = compressedFileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    setTimeout(() => {
                        URL.revokeObjectURL(link.href);
                    }, 100);
                }
            });

            function resetPreview() {
                originalPreview.classList.remove('has-image');
                originalImage.src = '';
                compressedPreview.classList.remove('has-image');
                compressedImage.src = '';
                originalSize.textContent = '0 KB';
                compressedSize.textContent = '0 KB';
                savings.textContent = '0%';
                savings.className = 'stat-value';
                compressionRatio.textContent = '0%';
                downloadSection.classList.add('hidden');
                statsContainer.style.display = 'block';
                warningMessage.style.display = 'none';
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';

                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html>